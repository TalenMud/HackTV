{% extends 'base.html' %}
{% block title %}HackTV - Watch stream{% endblock %}

{% block sidebar_selected %}
<div class="hidden" id="sidebar_selected">homeContainer</div>
{% endblock %}

{% block content%}
      <!--Main content(stream,chat etc.)-->
      <div class="mainContent w-full h-full flex items-center justify-center">
        <div id="watch-dashboard" class="mt-40 p-4">
        <div id="ad-section" class="absolute left-2 bottom-16 text-center p-4 max-w-[15rem]">
            <p class="font-[Silkscreen] text-2xl underline text-white mb-4">AD</p>
            <h1 id="ad-title" class="text-white mb-4">Loading...</h1>
            <a id="ad-link" href="#" target="_blank">
                <img id="ad-image" src="" alt="ad image" class="mb-4 w-64 mx-auto">
            </a>
            <button id="ad-button" class="border-gray-500 border-2 rounded p-2 w-fit mx-auto text-white hover:bg-gray-600 transition-all duration-200 transform hover:scale-110 active:scale-95">
                Loading...
            </button>
        </div>
        <div class="flex flex-col w-full items-center justify-center">

          <div class="relative overflow-hidden shadow-lg cursor-pointer text-center">
              <img id="stream-image" class="rounded-lg w-96 h-128 mx-auto" alt="Stream Image" />
              <p id="stream-status" class="text-white text-xl mt-2 hidden">The stream is currently on pause.</p>
          </div>

          <div id="comment-section" class="p-4 mt-16">
              <div class="flex items-center mb-4">
                  <input type="text" id="comment-input" placeholder="Add a comment" name="new-comment" class="commentInput bg-transparent p-2 w-full text-white" onkeyup="handleKeyUp(event)">
                  <button id="send-comment" class="text-white ml-2 hover:text-gray-400 cursor-pointer transition-all duration-300" onclick="sendComment()">
                      <i class="fas fa-paper-plane text-xl"></i>
                  </button>
              </div>
              <div id="comments">
                  <div>
                      <h1 class="text-white text-sm">@User_1 <span class="text-gray-400 text-xs">12 hours ago</span></h1>
                      <p class="text-gray-400 text-xs">Loved it</p>
                  </div>
                  <div>
                      <h1 class="text-white text-sm">@User_2 <span class="text-gray-400 text-xs">24 hours ago</span></h1>
                      <p class="text-gray-400 text-xs">Here from day 1</p>
                  </div>
              </div>
          </div>
        </div>
    </div>
{% endblock%}

{% block script%}

<script>
    const streamImage = document.getElementById('stream-image');
    const adTitle = document.getElementById('ad-title');
    const adImage = document.getElementById('ad-image');
    const adLink = document.getElementById('ad-link');
    const adButton = document.getElementById('ad-button');

    let streaming = false;

    async function getAd() {
        try {
            const response = await fetch('/getad');
            const ad = await response.json();

            adTitle.textContent = ad.ad;
            adImage.src = ad.image;
            adLink.href = ad.url;
            adButton.textContent = 'Learn More';
            adButton.addEventListener("click", () => {
                window.open(adLink.href, "_blank");
            });
        } catch (error) {
            console.error('Error fetching ad:', error);
            adTitle.textContent = 'Failed to load ad';
        }
    }

    async function getImage() {
        try {
            const response = await fetch('/stream/getimg');
            const textResponse = await response.text();

            if (textResponse === "No Image Found") {
                streamImage.style.display = 'none';
                return;
            }

            const imgBlob = await fetch('/stream/getimg').then(res => res.blob());
            const imgUrl = URL.createObjectURL(imgBlob);

            if (streamImage.src !== imgUrl) {
                streamImage.src = imgUrl;
                streamImage.style.display = 'block';
            }
        } catch (error) {
            console.error('There was a problem with the fetch operation:', error);
            streamImage.style.display = 'none';
        }
    }

    function startReceivingStream() {
        streaming = true;
        setInterval(getImage, 16);
    }

    function stopReceivingStream() {
        streaming = false;
        streamImage.style.display = 'none';
    }

    function addVideoToLocalStorage() {
        const videoId = crypto.randomUUID();
        const videoDetails = {
            id: videoId,
            title: "Sample Video Title",
            url: "https://example.com/video.mp4",
            thumbnail: "https://via.placeholder.com/150"
        };

        let history = JSON.parse(localStorage.getItem('history')) || [];
        history.push(videoDetails);
        localStorage.setItem('history', JSON.stringify(history));
    }

    window.addEventListener('load', () => {
        startReceivingStream();
        getAd();
        addVideoToLocalStorage();
    });
</script>

{% endblock %}
