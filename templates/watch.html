{% extends 'base.html' %}
{% block title %}HackTV - Watch stream{% endblock %}

{% block sidebar_selected %}
<div class="hidden" id="sidebar_selected">homeContainer</div>
{% endblock %}

{% block content%}

<style>
    .video-container {width: 100%;max-width: 1200px;position: relative;background: #000;border-radius: 8px;overflow: hidden;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);}
    video {width: 100%;height: auto;display: block;}
    :fullscreen .video-container {max-width: none;width: 100%;height: 100%;border-radius: 0;box-shadow: none;}
    :fullscreen video {height: 100%;object-fit: contain;}
    .controls {position: absolute;bottom: 0;left: 0;right: 0;background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);padding: 10px 15px;opacity: 0;transition: opacity 0.3s ease;z-index: 2;}
    .video-container:hover .controls {opacity: 1;}
    .control-bar {display: flex;align-items: center;gap: 15px;}
    .play-btn, .fullscreen-btn, .pip-btn {background: none;border: none;color: #fff;font-size: 20px;cursor: pointer;padding: 5px;transition: transform 0.2s ease;}
    .play-btn:hover, .fullscreen-btn:hover, .pip-btn:hover {transform: scale(1.1);}
    .progress-container {flex: 1;display: flex;align-items: center;gap: 10px;position: relative;}
    .time {color: #fff;font-family: Arial, sans-serif;font-size: 12px;min-width: 40px;}
    .progress-bar {flex: 1;height: 4px;background: rgba(255, 255, 255, 0.2);border-radius: 2px;position: relative;cursor: pointer;}
    .progress {height: 100%;background: #00aaff;border-radius: 2px;width: 0;transition: width 0.1s linear;}
    .volume-container {display: flex;align-items: center;gap: 5px;}
    .volume-btn {background: none;border: none;color: #fff;font-size: 16px;cursor: pointer;padding: 5px;}
    .volume-bar {width: 60px;height: 4px;background: rgba(255, 255, 255, 0.2);border-radius: 2px;position: relative;cursor: pointer;}
    .volume-level {height: 100%;background: #00aaff;border-radius: 2px;width: 100%;}
    .preview {position: absolute;bottom: 40px;width: 160px;height: 90px;background: #000;border: 1px solid #fff;border-radius: 4px;display: none;pointer-events: none;z-index: 3;}
    .share-container {position: relative;}
    .share-dropdown {position: absolute;top: 100%;left: 0;background: #1a1a1a;border-radius: 8px;box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);display: none;flex-direction: column;width: 180px;padding: 8px 0;z-index: 1000;transform: translateY(8px);opacity: 0;transition: opacity 0.2s ease, transform 0.2s ease;}
    .share-dropdown.active {display: flex;opacity: 1;transform: translateY(0);}
    .share-dropdown button {background: none;border: none;color: #fff;padding: 10px 16px;text-align: left;cursor: pointer;font-family: 'Varela', sans-serif;font-size: 14px;display: flex;align-items: center;gap: 8px;transition: background 0.2s ease, color 0.2s ease;}
    .share-dropdown button:hover {background: #333;color: #00aaff;}
    .share-dropdown button svg {width: 16px;height: 16px;}
    .comment-input-container {position: relative;width: 100%;}
    .emoji-picker {position: absolute;top: calc(100% + 10px);right: 0;background: #222;border-radius: 12px;box-shadow: 0 6px 20px rgba(0,0,0,0.5);display: none;width: 320px;padding: 15px;z-index: 1000;backdrop-filter: blur(5px);border: 1px solid rgba(255,255,255,0.1);}
    .emoji-picker.active {display: block;}
    .emoji-picker input {width: 100%;padding: 8px 12px;margin-bottom: 10px;background: rgba(255,255,255,0.05);border: 1px solid rgba(255,255,255,0.2);border-radius: 6px;color: #fff;outline: none;transition: border-color 0.3s ease;}
    .emoji-picker input:focus {border-color: #00aaff;}
    .emoji-grid {display: block;max-height: 200px;overflow-y: auto;padding-right: 5px;}
    .emoji-grid::-webkit-scrollbar {width: 6px;}
    .emoji-grid::-webkit-scrollbar-thumb {background: #444;border-radius: 3px;}
    .emoji-grid::-webkit-scrollbar-thumb:hover {background: #666;}
    .emoji-item {display: inline-block;margin: 4px;font-size: 24px;padding: 6px;text-align: center;cursor: pointer;border-radius: 6px;transition: all 0.2s ease;position: relative;}
    .emoji-item:hover {background: rgba(255,255,255,0.1);transform: scale(1.2);}
    .emoji-item:hover .emoji-tooltip {opacity: 1;}
    .emoji-tooltip {position: absolute;bottom: full;left: 1/2;transform: translateX(-50%);background: #gray-800;text: white;text-size: xs;padding-y: 1;padding-x: 2;border-radius: 0;opacity: 0;transition: opacity 0.2s ease;z-index: 10;white-space: nowrap;margin-bottom: 4px;}
</style>

<div id="ad-section" class="absolute left-2 bottom-16 text-center p-4 max-w-[15rem]">
    <div id="peer-id-display" class="text-white mt-4"><span id="peer-id"></span></div>
    <p class="font-[Silkscreen] text-2xl underline text-white mb-4">AD</p>
    <h1 id="ad-title" class="text-white mb-4">Loading...</h1>
    <a id="ad-link" href="#" target="_blank">
        <img id="ad-image" src="" alt="ad image" class="mb-4 w-64 mx-auto">
    </a>
    <button id="ad-button" class="border-gray-500 border-2 rounded p-2 w-fit mx-auto text-white hover:bg-gray-600 transition-all duration-200 transform hover:scale-110 active:scale-95">
        Loading...
    </button>
</div>

<div class="ml-24 w-full p-8 flex flex-row">
    <div class="w-[75%] overflow-y-scroll">
        <div class="video-container">
            <video id="videoPlayer">
                <source src="" type="video/mp4">
            </video>
            <div class="controls">
                <div class="control-bar">
                    <button class="play-btn"><i class="fas fa-play"></i></button>
                    <div class="progress-container">
                        <span class="time current-time">0:00</span>
                        <div class="progress-bar">
                            <div class="progress"></div>
                            <canvas class="preview" width="160" height="90"></canvas>
                        </div>
                        <span class="time duration">0:00</span>
                    </div>
                    <div class="volume-container">
                        <button class="volume-btn"><i class="fas fa-volume-up"></i></button>
                        <div class="volume-bar">
                            <div class="volume-level"></div>
                        </div>
                    </div>
                    <button class="pip-btn"><i class="fas fa-window-restore"></i></button>
                    <button class="fullscreen-btn"><i class="fas fa-expand"></i></button>
                </div>
            </div>
        </div>

        <h1 class="font-[Silkscreen] text-3xl text-white m-4" id="vidTitle">Some Cool vid</h1>
        <div class="w-full h-[6rem] flex flex-row justify-evenly items-center">
            <div class="share-container">
                <button id="shareButton" class="flex flex-col text-white ml-2 hover:text-gray-400 cursor-pointer transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="3rem" width="3rem"><path fill="#ffffff" d="M307 34.8c-11.5 5.1-19 16.6-19 29.2l0 64-112 0C78.8 128 0 206.8 0 304C0 417.3 81.5 467.9 100.2 478.1c2.5 1.4 5.3 1.9 8.1 1.9c10.9 0 19.7-8.9 19.7-19.7c0-7.5-4.3-14.4-9.8-19.5C108.8 431.9 96 414.4 96 384c0-53 43-96 96-96l96 0 0 64c0 12.6 7.4 24.1 19 29.2s25 3 34.4-5.4l160-144c6.7-6.1 10.6-14.7 10.6-23.8s-3.8-17.7-10.6-23.8l-160-144c-9.4-8.5-22.9-10.6-34.4-5.4z"/></svg>
                    <p class="text-white font-[Varela]">share</p>
                </button>
                <div id="shareDropdown" class="share-dropdown">
                    <button onclick="shareTo('facebook')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="#ffffff" d="M279.14 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.43 0 225.36 0c-73.22 0-121.08 44.38-121.08 124.72v70.62H22.89V288h81.39v224h100.17V288z"/></svg>
                        Facebook
                    </button>
                    <button onclick="shareTo('twitter')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#ffffff" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
                        Twitter
                    </button>
                    <button onclick="shareTo('linkedin')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="#ffffff" d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
                        LinkedIn
                    </button>
                    <button onclick="shareTo('whatsapp')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="#ffffff" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 37.9 53.4 48.5 72.3 14.3 32.8 22.9 58.3 27 64.5 3.7 6.2 2.3 9.8-1.4 13.4-3.4 3.6-8 4.6-12.5 2.8z"/></svg>
                        WhatsApp
                    </button>
                    <button onclick="shareTo('email')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#ffffff" d="M64 112c-8.8 0-16 7.2-16 16v22.1L220.5 291.7c20.7 18 50.4 18 71.1 0L464 150.1V128c0-8.8-7.2-16-16-16H64zM48 160.1V384c0 8.8 7.2 16 16 16H448c8.8 0 16-7.2 16-16V160.1L292 301.6c-20.7 18-50.4 18-71.1 0L48 160.1zM0 128C0 92.7 28.7 64 64 64H448c35.3 0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128z"/></svg>
                        Email
                    </button>
                </div>
            </div>
        </div>
        <hr class="text-[#303030] bg-[#303030] border-2 border-[#303030] my-8" height="2px" width="100%">
        <p class="font-[Varela] text-xl text-[#777777] m-4" id="vidDesc">Hey this is a cool video! Watch it and share it with your friends please:3</p>
    </div>

    <div id="comment-section" class="p-4 mt-16">
        <div class="flex items-center mb-4">
            <div class="comment-input-container">
                <input type="text" id="comment-input" placeholder="Add a comment" name="new-comment" onkeyup="handleKeyUp(event)" class="w-full px-4 py-2 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-[#9546fc] text-white placeholder-white/30">
                <button id="emoji-toggle" class="absolute right-10 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-400 cursor-pointer transition-all duration-300">
                    <i class="fas fa-smile text-xl"></i>
                </button>
                <div id="emoji-picker" class="emoji-picker">
                    <input type="text" id="emoji-search" placeholder="Search emojis...">
                    <div id="emoji-grid" class="emoji-grid"></div>
                </div>
            </div>
            <button id="send-comment" class="text-white ml-2 hover:text-gray-400 cursor-pointer transition-all duration-300" onclick="sendComment()">
                <i class="fas fa-paper-plane text-xl"></i>
            </button>
        </div>
        <div id="comments" class="space-y-4"></div>
    </div>
</div>

{% endblock%}

{% block script%}

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
const adTitle = document.getElementById('ad-title');
const adImage = document.getElementById('ad-image');
const adLink = document.getElementById('ad-link');
const adButton = document.getElementById('ad-button');
const commentsContainer = document.getElementById('comments');

document.getElementById('vidTitle').innerText = localStorage.getItem('title');
document.getElementById('vidDesc').innerText = localStorage.getItem('desc');

let streaming = false;

async function getAd() {
    try {
        const response = await fetch('/getad');
        const ad = await response.json();
        adTitle.textContent = ad.ad;
        adImage.src = ad.image;
        adLink.href = ad.url;
        adButton.textContent = 'Learn More';
        adButton.addEventListener("click", () => {
            window.open(adLink.href, "_blank");
        });
    } catch (error) {
        console.error('Error fetching ad:', error);
        adTitle.textContent = 'Failed to load ad';
    }
}

function addVideoToLocalStorage() {
    const videoId = crypto.randomUUID();
    const videoDetails = {
        id: videoId,
        title: localStorage.getItem('title'),
        url: localStorage.getItem('videoUrl'),
        thumbnail: localStorage.getItem('thumbUrl')
    };
    let history = JSON.parse(localStorage.getItem('history')) || [];
    history.push(videoDetails);
    localStorage.setItem('history', JSON.stringify(history));
}

function findClosestVideo(videos, targetUrl) {
    if (!videos || videos.length === 0) return null;
    let closestVideo = videos[0];
    let maxOverlap = 0;

    const targetParts = targetUrl.split('/').filter(part => part);
    videos.forEach(video => {
        const videoParts = video.url.split('/').filter(part => part);
        let overlap = 0;
        targetParts.forEach(part => {
            if (videoParts.includes(part)) overlap++;
        });
        if (overlap > maxOverlap) {
            maxOverlap = overlap;
            closestVideo = video;
        }
    });
    return closestVideo;
}

async function fetchComments() {
    const videoUrl = localStorage.getItem('videoUrl');
    try {
        const response = await fetch('/get-videos');
        const data = await response.json();
        if (data.status === 'success') {
            const exactMatch = data.videos.find(v => v.url === videoUrl);
            const video = exactMatch || findClosestVideo(data.videos, videoUrl);
            if (video && video.comments) {
                renderComments(video.comments);
            } else {
                commentsContainer.innerHTML = '<p class="text-gray-400 text-sm">No comments yet.</p>';
            }
        }
    } catch (error) {
        console.error('Error fetching comments:', error);
        commentsContainer.innerHTML = '<p class="text-gray-400 text-sm">Failed to load comments.</p>';
    }
}

function renderComments(comments) {
    commentsContainer.innerHTML = '';
    comments.forEach(comment => {
        const timeAgo = new Date(comment.timestamp).toLocaleString();
        const commentDiv = document.createElement('div');
        const renderedComment = marked.parse(comment.text, { breaks: true, sanitize: true });
        commentDiv.innerHTML = `
            <h1 class="text-white text-sm">@${comment.username} <span class="text-gray-400 text-xs">${timeAgo}</span></h1>
            <p class="text-gray-400 text-xs">${renderedComment}</p>
        `;
        commentsContainer.appendChild(commentDiv);
    });
}

async function sendComment() {
    const commentInput = document.getElementById('comment-input');
    const commentText = commentInput.value.trim();
    const videoUrl = localStorage.getItem('videoUrl');
    const loginData = localStorage.getItem('loginforhacktv');

    if (!commentText || !videoUrl) {
        alert('Please enter a comment and ensure a video is loaded.');
        return;
    }
    if (!loginData) {
        alert('You must be logged in to comment.');
        return;
    }

    const username = loginData.split(':')[0];

    try {
        const response = await fetch('/get-videos');
        const data = await response.json();
        const exactMatch = data.videos.find(v => v.url === videoUrl);
        const video = exactMatch || findClosestVideo(data.videos, videoUrl);
        if (!video) {
            alert('No matching video found.');
            return;
        }

        const commentData = {
            video_id: video.id,
            comment: commentText,
            username: username
        };
        const createResponse = await fetch('/create-comment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(commentData)
        });
        const result = await createResponse.json();

        if (result.status === 'success') {
            commentInput.value = '';
            await fetchComments();
        } else {
            alert('Failed to post comment: ' + result.message);
        }
    } catch (error) {
        console.error('Error posting comment:', error);
        alert('Error posting comment.');
    }
}

function handleKeyUp(event) {
    if (event.key === 'Enter') {
        sendComment();
    }
}

window.addEventListener('load', () => {
    getAd();
    addVideoToLocalStorage();
    fetchComments();

    const shareButton = document.getElementById('shareButton');
    const shareDropdown = document.getElementById('shareDropdown');
    const shareUrl = encodeURIComponent(window.location.href);
    const shareTitle = encodeURIComponent(document.querySelector('h1.text-3xl').textContent.trim());

    shareButton.addEventListener('click', (e) => {
        e.preventDefault();
        shareDropdown.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
        if (!shareButton.contains(e.target) && !shareDropdown.contains(e.target)) {
            shareDropdown.classList.remove('active');
        }
    });

    window.shareTo = function(platform) {
        const urlMap = {
            facebook: `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`,
            twitter: `https://twitter.com/intent/tweet?url=${shareUrl}&text=${shareTitle}`,
            linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`,
            whatsapp: `https://api.whatsapp.com/send?text=${shareTitle}%20${shareUrl}`,
            email: `mailto:?subject=${shareTitle}&body=Check%20this%20out:%20${shareUrl}`
        };
        if (urlMap[platform]) {
            window.open(urlMap[platform], '_blank', 'width=600,height=400');
        }
        shareDropdown.classList.remove('active');
    };

    const emojiToggle = document.getElementById('emoji-toggle');
    const emojiPicker = document.getElementById('emoji-picker');
    const emojiSearch = document.getElementById('emoji-search');
    const emojiGrid = document.getElementById('emoji-grid');
    const commentInput = document.getElementById('comment-input');

    const emojiCategories = {
        'Smileys': [
            { emoji: '😀', title: 'grinning face' },
            { emoji: '😊', title: 'smiling face with smiling eyes' },
            { emoji: '😂', title: 'face with tears of joy' },
            { emoji: '🤓', title: 'nerd face' },
            { emoji: '😎', title: 'smiling face with sunglasses' },
            { emoji: '😍', title: 'smiling face with heart-eyes' },
            { emoji: '😢', title: 'crying face' },
            { emoji: '😡', title: 'pouting face' }
        ],
        'Gestures': [
            { emoji: '👍', title: 'thumbs up' },
            { emoji: '👎', title: 'thumbs down' },
            { emoji: '👏', title: 'clapping hands' },
            { emoji: '🙌', title: 'raising hands' },
            { emoji: '🤝', title: 'handshake' },
            { emoji: '💪', title: 'flexed biceps' }
        ],
        'Hearts': [
            { emoji: '❤️', title: 'red heart' },
            { emoji: '💖', title: 'sparkling heart' },
            { emoji: '💙', title: 'blue heart' },
            { emoji: '💚', title: 'green heart' },
            { emoji: '💛', title: 'yellow heart' },
            { emoji: '💜', title: 'purple heart' }
        ],
        'Celebration': [
            { emoji: '🎉', title: 'party popper' },
            { emoji: '🔥', title: 'fire' },
            { emoji: '⭐', title: 'star' },
            { emoji: '✨', title: 'sparkles' },
            { emoji: '🌟', title: 'glowing star' },
            { emoji: '🎁', title: 'gift' },
            { emoji: '🎄', title: 'christmas tree' }
        ],
        'Food': [
            { emoji: '🍕', title: 'pizza' },
            { emoji: '🍔', title: 'hamburger' },
            { emoji: '🍟', title: 'french fries' },
            { emoji: '☕', title: 'hot beverage' },
            { emoji: '🍺', title: 'beer mug' },
            { emoji: '🎂', title: 'birthday cake' }
        ],
        'Other': [
            { emoji: '👀', title: 'eyes' },
            { emoji: '🤔', title: 'thinking face' },
            { emoji: '🎵', title: 'musical note' },
            { emoji: '🚀', title: 'rocket' },
            { emoji: '😋', title: 'face savoring food' },
            { emoji: '😴', title: 'sleeping face' },
            { emoji: '🤗', title: 'hugging face' }
        ]
    };

    function renderEmojis(searchTerm = '') {
        emojiGrid.innerHTML = '';
        
        Object.entries(emojiCategories).forEach(([category, emojis]) => {
            const filteredEmojis = emojis.filter(item => 
                item.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.emoji.includes(searchTerm)
            );
            
            if (filteredEmojis.length > 0) {
                const categoryHeader = document.createElement('div');
                categoryHeader.textContent = category;
                categoryHeader.className = 'text-white font-bold text-sm mt-2 mb-1 px-2';
                emojiGrid.appendChild(categoryHeader);
                
                filteredEmojis.forEach(item => {
                    const span = document.createElement('span');
                    span.textContent = item.emoji;
                    span.dataset.title = `:${item.title.replace(/ /g, '-')}:`;
                    span.className = 'relative emoji-item';
                    
                    const tooltip = document.createElement('div');
                    tooltip.textContent = span.dataset.title;
                    tooltip.className = 'absolute bottom-full left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs py-1 px-2 rounded opacity-0 transition-opacity duration-200 pointer-events-none';
                    span.appendChild(tooltip);
                    
                    span.addEventListener('mouseenter', () => {
                        tooltip.classList.add('opacity-100');
                    });
                    
                    span.addEventListener('mouseleave', () => {
                        tooltip.classList.remove('opacity-100');
                    });
                    
                    span.addEventListener('click', () => {
                        commentInput.value += item.emoji;
                        emojiPicker.classList.remove('active');
                        commentInput.focus();
                    });
                    
                    emojiGrid.appendChild(span);
                });
            }
        });
    }

    emojiToggle.addEventListener('click', () => {
        emojiPicker.classList.toggle('active');
        if (emojiPicker.classList.contains('active')) {
            emojiSearch.focus();
            renderEmojis();
        }
    });

    emojiSearch.addEventListener('input', (e) => {
        renderEmojis(e.target.value);
    });

    document.addEventListener('click', (e) => {
        if (!emojiToggle.contains(e.target) && !emojiPicker.contains(e.target)) {
            emojiPicker.classList.remove('active');
        }
    });
});

const videoUrl = localStorage.getItem('videoUrl');
const video = document.getElementById('videoPlayer');
const playBtn = document.querySelector('.play-btn');
const progressBar = document.querySelector('.progress-bar');
const progress = document.querySelector('.progress');
const currentTime = document.querySelector('.current-time');
const durationTime = document.querySelector('.duration');
const volumeBtn = document.querySelector('.volume-btn');
const volumeBar = document.querySelector('.volume-bar');
const volumeLevel = document.querySelector('.volume-level');
const fullscreenBtn = document.querySelector('.fullscreen-btn');
const pipBtn = document.querySelector('.pip-btn');
const preview = document.querySelector('.preview');
let thumbnails = {};

if (!videoUrl) {
    document.body.innerHTML = 'No video URL provided';
} else {
    video.querySelector('source').src = videoUrl;
    video.load();

    video.addEventListener('loadedmetadata', () => {
        durationTime.textContent = formatTime(video.duration);
        generateThumbnails();
    });

    playBtn.addEventListener('click', () => {
        if (video.paused) {
            video.play();
            playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        } else {
            video.pause();
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
    });

    video.addEventListener('timeupdate', () => {
        const percent = (video.currentTime / video.duration) * 100;
        progress.style.width = percent + '%';
        currentTime.textContent = formatTime(video.currentTime);
    });

    progressBar.addEventListener('click', (e) => {
        const rect = progressBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        video.currentTime = percent * video.duration;
    });

    progressBar.addEventListener('mousemove', (e) => {
        const rect = progressBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        const time = percent * video.duration;
        const previewTime = Math.floor(time / 10) * 10;

        if (thumbnails[previewTime]) {
            const ctx = preview.getContext('2d');
            ctx.clearRect(0, 0, preview.width, preview.height);
            ctx.drawImage(thumbnails[previewTime], 0, 0, 160, 90);
            preview.style.left = Math.min(
                Math.max(e.clientX - rect.left - 80, 0),
                rect.width - 160
            ) + 'px';
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    });

    progressBar.addEventListener('mouseleave', () => {
        preview.style.display = 'none';
    });

    volumeBtn.addEventListener('click', () => {
        video.muted = !video.muted;
        volumeBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
        volumeLevel.style.width = video.muted ? '0%' : (video.volume * 100) + '%';
    });

    volumeBar.addEventListener('click', (e) => {
        const rect = volumeBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        video.volume = percent;
        video.muted = false;
        volumeBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
        volumeLevel.style.width = (percent * 100) + '%';
    });

    fullscreenBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
            document.querySelector('.video-container').requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    });

    pipBtn.addEventListener('click', async () => {
        try {
            if (document.pictureInPictureElement) {
                await document.exitPictureInPicture();
                pipBtn.innerHTML = '<i class="fas fa-window-restore"></i>';
            } else {
                await video.requestPictureInPicture();
                pipBtn.innerHTML = '<i class="fas fa-window-minimize"></i>';
            }
        } catch (error) {
            console.error('Error toggling Picture-in-Picture:', error);
            alert('Picture-in-Picture is not supported or failed to toggle.');
        }
    });

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return mins + ':' + (secs < 10 ? '0' + secs : secs);
    }

    function generateThumbnails() {
        const canvas = document.createElement('canvas');
        canvas.width = 160;
        canvas.height = 90;
        const ctx = canvas.getContext('2d');
        const duration = video.duration;
        const interval = Math.min(10, duration / 10);

        let currentTime = 0;

        function capture() {
            if (currentTime >= duration) return;

            video.currentTime = currentTime;
            video.addEventListener('seeked', function onSeeked() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(video, 0, 0, 160, 90);
                thumbnails[Math.floor(currentTime)] = new Image();
                thumbnails[Math.floor(currentTime)].src = canvas.toDataURL();
                video.removeEventListener('seeked', onSeeked);
                currentTime += interval;
                capture();
            }, { once: true });
        }

        capture();
    }
}
</script>

{% endblock %}